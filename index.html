<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaFo AI | –ú—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω—ã–π –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —à—Ä–∏—Ñ—Ç–∞ Inter –∏ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            overflow: hidden;
        }

        /* –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–ø–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω) */
        #app-container {
            height: 100vh;
            display: flex;
            background-color: white;
            box-shadow: 0 8px 32px rgba(25, 118, 210, 0.15);
            border-radius: 12px;
            margin: 8px;
            overflow: hidden;
        }

        /* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å */
        #sidebar {
            width: 100%;
            max-width: 280px;
            background: linear-gradient(180deg, #1976d2 0%, #1565c0 100%);
            color: white;
            border-right: 2px solid #1565c0;
            transition: transform 0.3s ease-in-out;
            z-index: 50;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä–æ–ª–ª–∏—Ä—É–µ–º—ã—Ö –æ–±–ª–∞—Å—Ç–µ–π */
        .scrollable-area {
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.3) transparent;
        }
        .scrollable-area::-webkit-scrollbar {
            width: 6px;
        }
        .scrollable-area::-webkit-scrollbar-thumb {
            background-color: rgba(255,255,255,0.3);
            border-radius: 10px;
        }
        .scrollable-area::-webkit-scrollbar-track {
            background: transparent;
        }

        /* –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ */
        #chat-main-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background: linear-gradient(180deg, #fafafa 0%, #f5f5f5 100%);
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ */
        #chat-body {
            flex-grow: 1;
            overflow-y: auto;
        }

        /* –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
        .user-message-container {
            background-color: white;
            border-top: 1px solid #e3f2fd;
            padding: 1.5rem 0;
        }
        .user-message {
            max-width: 768px;
            margin: 0 auto;
            width: 100%;
            padding: 0 1.5rem;
            color: #1565c0;
        }

        /* –°–æ–æ–±—â–µ–Ω–∏–µ –ò–ò (—Å–≤–µ—Ç–ª—ã–π —Ñ–æ–Ω) */
        .ai-message-container {
            background: linear-gradient(90deg, #f8fbff 0%, #f3f8ff 100%);
            border-top: 1px solid #e3f2fd;
            padding: 1.5rem 0;
        }
        .ai-message {
            max-width: 768px;
            margin: 0 auto;
            width: 100%;
            padding: 0 1.5rem;
            color: #1565c0;
        }

        /* –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤ */
        .chat-history-item {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        .chat-history-item:hover {
            background: rgba(255,255,255,0.2);
            transform: translateX(4px);
        }
        .chat-history-item.active {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
        }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn-primary {
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            box-shadow: 0 4px 16px rgba(25, 118, 210, 0.3);
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%);
            box-shadow: 0 6px 20px rgba(25, 118, 210, 0.4);
            transform: translateY(-2px);
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ (Dot Pulse) */
        .dot-pulse { 
            position: relative; 
            left: -9999px; 
            width: 6px; 
            height: 6px; 
            border-radius: 50%; 
            background-color: #1976d2; 
            color: #1976d2; 
            box-shadow: 9999px 0 0 -5px; 
            animation: dotPulse 1.5s infinite linear; 
            animation-delay: 0.25s; 
        }
        .dot-pulse::before, .dot-pulse::after { 
            content: ''; 
            display: inline-block; 
            position: absolute; 
            top: 0; 
            width: 6px; 
            height: 6px; 
            border-radius: 50%; 
            background-color: #1976d2; 
            color: #1976d2; 
        }
        .dot-pulse::before { 
            left: -9999px; 
            box-shadow: 9994px 0 0 -5px; 
            animation: dotPulseBefore 1.5s infinite linear; 
            animation-delay: 0s; 
        }
        .dot-pulse::after { 
            left: 9999px; 
            box-shadow: -9994px 0 0 -5px; 
            animation: dotPulseAfter 1.5s infinite linear; 
            animation-delay: 0.5s; 
        }
        @keyframes dotPulseBefore { 
            0% { box-shadow: 9994px 0 0 -5px; } 
            30% { box-shadow: 9994px 0 0 2px; } 
            60%, 100% { box-shadow: 9994px 0 0 -5px; } 
        }
        @keyframes dotPulse { 
            0% { box-shadow: 9999px 0 0 -5px; } 
            30% { box-shadow: 9999px 0 0 2px; } 
            60%, 100% { box-shadow: 9999px 0 0 -5px; } 
        }
        @keyframes dotPulseAfter { 
            0% { box-shadow: -9994px 0 0 -5px; } 
            30% { box-shadow: -9994px 0 0 2px; } 
            60%, 100% { box-shadow: -9994px 0 0 -5px; } 
        }

        /* –ì–ª–∞—Å—Å–º–æ—Ä—Ñ–∏–∑–º —ç—Ñ—Ñ–µ–∫—Ç—ã */
        .glass-effect {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-slide-up {
            animation: slideInUp 0.3s ease-out;
        }
    </style>
</head>
<body>

<div id="app-container" class="md:flex">
    
    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
    <div id="sidebar" class="fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 flex flex-col scrollable-area overflow-y-auto z-50">
        <div class="p-4 flex flex-col flex-grow">
            <!-- –õ–æ–≥–æ—Ç–∏–ø –∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div class="text-center mb-6">
                <div class="w-16 h-16 mx-auto mb-3 rounded-full overflow-hidden">
                    <img src="Tafo_ai.png" alt="TaFo AI –õ–æ–≥–æ—Ç–∏–ø" class="w-full h-full object-cover">
                </div>
                <div> 
                    <h2 class="text-xl font-bold text-white">TaFo AI</h2>
                    <p class="text-xs text-white/70">–í–∞—à —É–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫</p>
                </div>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∞ "–ù–æ–≤—ã–π —á–∞—Ç" -->
            <button onclick="clearChat()" class="w-full text-left py-3 px-4 rounded-xl glass-effect text-blue-700 hover:bg-white/20 transition-all duration-300 mb-6 flex items-center group">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr-3 group-hover:rotate-90 transition-transform duration-300">
                    <circle cx="10" cy="10" r="8" stroke="currentColor" stroke-width="1.5"/>
                    <path d="M10 6v8M6 10h8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
                –ù–æ–≤—ã–π —á–∞—Ç
            </button>
            
            <!-- –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤ -->
            <div class="space-y-2 flex-grow">
                <p class="text-xs text-white/60 uppercase px-3 mb-3 font-semibold tracking-wide">–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤</p>
                <div id="chat-history-list" class="text-sm space-y-2">
                    <!-- –ß–∞—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
        </div>
        
        <!-- –ù–∏–∂–Ω—è—è —á–∞—Å—Ç—å —Å –±—Ä–µ–Ω–¥–∏–Ω–≥–æ–º -->
        <div class="p-4 border-t border-white/20">
            <div class="text-center">
                <div class="text-sm font-semibold text-white mb-1">
                    TaFo AI Assistant
                </div>
                <div class="text-xs text-white/60">
                    –æ—Ç MusTaFo Company AI
                </div>
                <div class="text-xs text-white/40 mt-2">
                    –í–µ—Ä—Å–∏—è 0.5 Beta
                </div>
            </div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
    <div id="chat-main-area">
        
        <!-- –®–∞–ø–∫–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö -->
        <header class="p-4 bg-white border-b-2 border-blue-100 shadow-sm md:hidden flex items-center justify-between z-40">
            <button onclick="toggleSidebar()" class="p-2 rounded-xl hover:bg-blue-50 text-blue-600 transition-colors duration-200">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 5h14M3 10h14M3 15h14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
            </button>
            <div class="flex items-center">
                <div class="w-8 h-8 mr-2 bg-blue-500 rounded-lg flex items-center justify-center overflow-hidden">
                    <img src="tafoai.png" alt="TaFo AI" class="w-full h-full object-cover">
                </div>
                <h1 class="text-lg font-bold text-blue-600">TaFo AI</h1>
            </div>
            <button onclick="clearChat()" class="p-2 rounded-xl hover:bg-blue-50 text-blue-600 transition-colors duration-200">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="10" cy="10" r="8" stroke="currentColor" stroke-width="1.5"/>
                    <path d="M10 6v8M6 10h8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
            </button>
        </header>

        <!-- –û–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ –∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π —ç–∫—Ä–∞–Ω -->
        <div id="chat-body" class="scrollable-area">
            
            <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π —ç–∫—Ä–∞–Ω -->
            <div id="welcome-screen" class="p-8 text-center flex flex-col items-center justify-center min-h-full">
                <div class="max-w-2xl w-full">
                    <!-- –ì–ª–∞–≤–Ω—ã–π –ª–æ–≥–æ—Ç–∏–ø -->
                    <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center shadow-2xl animate-pulse overflow-hidden">
                        <img src="tafoai.png" alt="TaFo AI" class="w-full h-full object-cover">
                    </div>
                    
                    <h2 class="text-4xl font-bold text-blue-600 mb-3">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ TaFo AI!</h2>
                    <p class="text-blue-500 mb-10 text-lg font-medium">–æ—Ç MusTaFo Company AI</p>

                   <p class="text-xl text-blue-700 mb-12 leading-relaxed">
    –ü—Ä–∏–≤–µ—Ç! <strong class="text-blue-1500"> –ú–µ–Ω—è –∑–æ–≤—É—Ç TaFo AI ! </strong> –Ø —É–º–µ—é <strong class="text-blue-400">–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∏</strong> –∏ <strong class="text-blue-600">–≥–æ–≤–æ—Ä–∏—Ç—å –≤—Å–ª—É—Ö</strong>. 
    –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?
</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-left">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-2xl shadow-lg hover:shadow-xl cursor-pointer transition-all duration-300 transform hover:-translate-y-2 group" onclick="userInput.value='–ß—Ç–æ —Ç—ã –≤–∏–¥–∏—à—å –Ω–∞ —ç—Ç–æ–π —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏?'; autoResize(userInput); sendButton.disabled=false; userInput.focus();">
                            <div class="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center mb-4 group-hover:scale-110 transition-transform duration-300">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="3" y="4" width="18" height="14" rx="2" stroke="white" stroke-width="2"/>
                                    <circle cx="8.5" cy="8.5" r="1.5" stroke="white" stroke-width="2"/>
                                    <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21" stroke="white" stroke-width="2"/>
                                </svg>
                            </div>
                            <h3 class="font-bold text-blue-800 mb-2 text-lg">üì∏ –ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</h3>
                            <p class="text-blue-600">–ó–∞–≥—Ä—É–∂–∞–π—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏, –∏ —è –¥–µ—Ç–∞–ª—å–Ω–æ –æ–ø–∏—à—É, —á—Ç–æ –Ω–∞ –Ω–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–æ.</p>
                        </div>
                        
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-2xl shadow-lg hover:shadow-xl cursor-pointer transition-all duration-300 transform hover:-translate-y-2 group" onclick="userInput.value='–†–∞—Å—Å–∫–∞–∂–∏ –º–Ω–µ –æ –≥–æ–ª–æ—Å–æ–≤—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö TaFo AI.'; autoResize(userInput); sendButton.disabled=false; userInput.focus();">
                            <div class="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center mb-4 group-hover:scale-110 transition-transform duration-300">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 2a3 3 0 0 0-3 3v6a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z" stroke="white" stroke-width="2"/>
                                    <path d="M19 10v1a7 7 0 0 1-14 0v-1M12 18v4M8 22h8" stroke="white" stroke-width="2"/>
                                </svg>
                            </div>
                            <h3 class="font-bold text-blue-800 mb-2 text-lg">üó£Ô∏è –ì–æ–ª–æ—Å–æ–≤–æ–µ –æ–±—â–µ–Ω–∏–µ</h3>
                            <p class="text-blue-600">–ì–æ–≤–æ—Ä–∏—Ç–µ —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–º –∏–ª–∏ —Å–ª—É—à–∞–π—Ç–µ –º–æ–∏ –≥–æ–ª–æ—Å–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã.</p>
                        </div>
                    </div>

                    <div class="mt-12 p-4 bg-blue-50 rounded-xl">
                        <p class="text-blue-600 text-sm">
                            üí° <strong>–°–æ–≤–µ—Ç:</strong> –ù–∞—á–Ω–∏—Ç–µ —Å –ø—Ä–æ—Å—Ç–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞!
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- –û–±–ª–∞—Å—Ç—å –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π -->
            <div id="conversation-area" class="hidden flex flex-col gap-0 pb-20">
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ -->
            </div>
        </div>

        <!-- –û–±–ª–∞—Å—Ç—å –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞ –≤–Ω–∏–∑—É) -->
        <div id="input-container" class="sticky bottom-0 bg-white/95 backdrop-blur-md pt-6 pb-6 px-4 border-t-2 border-blue-100 flex justify-center flex-col items-center">
            
            <!-- –û–±–ª–∞—Å—Ç—å –ø—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
            <div id="image-preview-container" class="mb-4 p-3 bg-blue-50 rounded-2xl hidden max-w-xl w-full border border-blue-200">
                <!-- –°—é–¥–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –ø—Ä–µ–≤—å—é -->
            </div>

            <div class="max-w-xl w-full">
                <div class="flex items-end space-x-3 bg-white border-2 border-blue-200 rounded-3xl p-3 shadow-2xl glass-effect">
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
                    <input type="file" id="image-input" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
                    <button 
                        onclick="document.getElementById('image-input').click()" 
                        class="p-3 text-blue-500 rounded-2xl hover:bg-blue-50 transition-all duration-200 group"
                        title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"
                        id="image-button"
                    >
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="group-hover:scale-110 transition-transform duration-200">
                            <rect x="3" y="4" width="18" height="14" rx="2" stroke="currentColor" stroke-width="2"/>
                            <circle cx="8.5" cy="8.5" r="1.5" stroke="currentColor" stroke-width="2"/>
                            <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </button>
                    
                    <textarea
                        id="user-input"
                        rows="1"
                        placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –≥–æ–≤–æ—Ä–∏—Ç–µ —Å TaFo AI..."
                        class="flex-grow p-2 pl-4 bg-transparent resize-none focus:outline-none max-h-40 overflow-y-auto text-blue-700 placeholder-blue-400"
                        oninput="autoResize(this)"
                        onkeydown="handleKey(event)"
                    ></textarea>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ -->
                    <button 
                        id="voice-button"
                        onclick="startSpeechInput()" 
                        class="p-3 text-blue-500 rounded-2xl hover:bg-blue-50 transition-all duration-200 group"
                        title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥"
                    >
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="group-hover:scale-110 transition-transform duration-200">
                            <path d="M12 2a3 3 0 0 0-3 3v6a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z" stroke="currentColor" stroke-width="2"/>
                            <path d="M19 10v1a7 7 0 0 1-14 0v-1M12 18v4M8 22h8" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </button>

                    <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
                    <button
                        id="send-button"
                        onclick="sendMessage()"
                        class="btn-primary p-3 text-white rounded-2xl transition-all duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none group"
                        disabled
                    >
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="group-hover:translate-x-1 transition-transform duration-200">
                            <path d="M2 12l20-8-8 20-4-7-7-4z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
                <p class="text-xs text-blue-400 mt-3 text-center">
                    TaFo AI –º–æ–∂–µ—Ç –¥–æ–ø—É—Å–∫–∞—Ç—å –æ—à–∏–±–∫–∏. –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –≤–∞–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. üîí –í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –∑–∞—â–∏—â–µ–Ω—ã.
                </p>
            </div>
        </div>

    </div>
    
    <!-- –ü–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –º–µ–Ω—é -->
    <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black opacity-0 md:hidden pointer-events-none transition-opacity duration-300 z-40"></div>

</div>

<script>
    // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
    const apiKey = "AIzaSyDFNLkeBjAJsKnNocQ5MyE5HkiAZubkQDg"; 
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const welcomeScreen = document.getElementById('welcome-screen');
    const conversationArea = document.getElementById('conversation-area');
    const chatBody = document.getElementById('chat-body');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const voiceButton = document.getElementById('voice-button');
    const imageInput = document.getElementById('image-input');
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const chatHistoryList = document.getElementById('chat-history-list');

    let isFetching = false;
    let isListening = false;
    let conversationContext = [];
    let uploadedImageBase64 = null;
    let uploadedImageMimeType = null;
    let recognition = null; // –î–ª—è SpeechRecognition
    let chatHistory = []; // –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–æ–≤
    let currentChatId = null;
    let chatIdCounter = 1;

    // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ò–°–¢–û–†–ò–ï–ô –ß–ê–¢–û–í ---

    function createNewChat() {
        const chatId = `chat_${chatIdCounter++}`;
        const chatTitle = generateChatTitle();
        
        const newChat = {
            id: chatId,
            title: chatTitle,
            messages: [],
            createdAt: new Date(),
            lastActivity: new Date()
        };
        
        chatHistory.unshift(newChat); // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ –º–∞—Å—Å–∏–≤–∞
        currentChatId = chatId;
        
        updateChatHistoryUI();
        saveChatHistory();
        return newChat;
    }

    function generateChatTitle() {
        const titles = [
            "–ù–æ–≤–∞—è –±–µ—Å–µ–¥–∞",
            "–ß–∞—Ç —Å –ò–ò",
            "–û–±—Å—É–∂–¥–µ–Ω–∏–µ",
            "–í–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã",
            "–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è",
            "–ü–æ–º–æ—â—å TaFo AI"
        ];
        return titles[Math.floor(Math.random() * titles.length)];
    }

    function updateChatTitle(chatId, firstMessage) {
        const chat = chatHistory.find(c => c.id === chatId);
        if (chat && firstMessage.length > 0) {
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
            let title = firstMessage.substring(0, 30);
            if (firstMessage.length > 30) title += "...";
            chat.title = title;
            updateChatHistoryUI();
            saveChatHistory();
        }
    }

    function switchToChat(chatId) {
        const chat = chatHistory.find(c => c.id === chatId);
        if (!chat) return;

        currentChatId = chatId;
        conversationContext = [...chat.messages];
        
        // –û—á–∏—â–∞–µ–º –æ–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
        conversationArea.innerHTML = '';
        
        if (chat.messages.length === 0) {
            showWelcomeScreen();
        } else {
            showConversation();
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
            for (let i = 0; i < chat.messages.length; i += 2) {
                const userMsg = chat.messages[i];
                const aiMsg = chat.messages[i + 1];
                
                if (userMsg && userMsg.role === 'user') {
                    const userText = userMsg.parts.find(p => p.text)?.text || "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ";
                    const hasImage = userMsg.parts.some(p => p.inlineData);
                    addMessage(userText, 'user', false, hasImage ? userMsg.parts.find(p => p.inlineData)?.inlineData?.data : null);
                }
                
                if (aiMsg && aiMsg.role === 'model') {
                    const aiText = aiMsg.parts.find(p => p.text)?.text || "–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞";
                    addMessage(aiText, 'ai');
                }
            }
        }
        
        updateChatHistoryUI();
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–∞–π–¥–±–∞—Ä –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
        if (!sidebar.classList.contains('-translate-x-full')) {
            toggleSidebar();
        }
    }

    function updateChatHistoryUI() {
        chatHistoryList.innerHTML = '';
        
        if (chatHistory.length === 0) {
            chatHistoryList.innerHTML = `
                <div class="text-center text-white/50 text-sm py-4">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mx-auto mb-2 opacity-50">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10z" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    –ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤
                </div>
            `;
            return;
        }
        
        chatHistory.forEach(chat => {
            const chatItem = document.createElement('div');
            chatItem.className = `chat-history-item p-3 rounded-xl cursor-pointer transition-all duration-300 group ${
                chat.id === currentChatId ? 'active' : ''
            }`;
            
            const timeAgo = getTimeAgo(chat.lastActivity);
            const messageCount = Math.floor(chat.messages.length / 2);
            
            chatItem.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex-grow min-w-0">
                        <h4 class="font-medium text-white text-sm truncate mb-1">${chat.title}</h4>
                        <div class="flex items-center text-xs text-white/60 space-x-2">
                            <span>${timeAgo}</span>
                            ${messageCount > 0 ? `<span>‚Ä¢</span><span>${messageCount} —Å–æ–æ–±—â–µ–Ω–∏–π</span>` : ''}
                        </div>
                    </div>
                    <button onclick="deleteChatHistory('${chat.id}'); event.stopPropagation();" 
                            class="opacity-0 group-hover:opacity-100 p-1 hover:bg-white/20 rounded transition-all duration-200">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M10 11v6M14 11v6" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </button>
                </div>
            `;
            
            chatItem.onclick = () => switchToChat(chat.id);
            chatHistoryList.appendChild(chatItem);
        });
    }

    function deleteChatHistory(chatId) {
        chatHistory = chatHistory.filter(chat => chat.id !== chatId);
        
        if (currentChatId === chatId) {
            if (chatHistory.length > 0) {
                switchToChat(chatHistory[0].id);
            } else {
                clearChat();
            }
        }
        
        updateChatHistoryUI();
        saveChatHistory();
    }

    function getTimeAgo(date) {
        const now = new Date();
        const diffMs = now - new Date(date);
        const diffMins = Math.floor(diffMs / (1000 * 60));
        const diffHours = Math.floor(diffMins / 60);
        const diffDays = Math.floor(diffHours / 24);
        
        if (diffMins < 1) return '—Å–µ–π—á–∞—Å';
        if (diffMins < 60) return `${diffMins} –º–∏–Ω –Ω–∞–∑–∞–¥`;
        if (diffHours < 24) return `${diffHours} —á –Ω–∞–∑–∞–¥`;
        if (diffDays < 7) return `${diffDays} –¥–Ω –Ω–∞–∑–∞–¥`;
        return new Date(date).toLocaleDateString('ru-RU');
    }

    function saveChatHistory() {
        try {
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
            // –î–ª—è –¥–µ–º–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –≤ –ø–∞–º—è—Ç–∏
            console.log('–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞:', chatHistory.length, '—á–∞—Ç–æ–≤');
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–æ–≤:', error);
        }
    }

    function loadChatHistory() {
        try {
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
            // –î–ª—è –¥–µ–º–æ —Å–æ–∑–¥–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∏–º–µ—Ä–æ–≤ —á–∞—Ç–æ–≤
            chatHistory = [
                {
                    id: 'demo_1',
                    title: '–ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π',
                    messages: [],
                    createdAt: new Date(Date.now() - 86400000), // 1 –¥–µ–Ω—å –Ω–∞–∑–∞–¥
                    lastActivity: new Date(Date.now() - 86400000)
                },
                {
                    id: 'demo_2',
                    title: '–ì–æ–ª–æ—Å–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏',
                    messages: [],
                    createdAt: new Date(Date.now() - 172800000), // 2 –¥–Ω—è –Ω–∞–∑–∞–¥
                    lastActivity: new Date(Date.now() - 172800000)
                }
            ];
            chatIdCounter = 3;
            updateChatHistoryUI();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–æ–≤:', error);
            chatHistory = [];
        }
    }

    // --- –£–¢–ò–õ–ò–¢–´ UI ---

    function autoResize(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
        const isEmpty = textarea.value.trim().length === 0 && !uploadedImageBase64;
        sendButton.disabled = isEmpty || isFetching;
    }
    
    function handleKey(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            if (!sendButton.disabled) {
                sendMessage();
            }
        }
    }

    // --- –ì–û–õ–û–°–û–í–û–ô –í–´–í–û–î (TTS) ---

    function speakText(text) {
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ru-RU'; 
            utterance.rate = 0.9;
            utterance.pitch = 1;
            
            window.speechSynthesis.cancel(); 
            window.speechSynthesis.speak(utterance);
        } else {
            console.warn("Speech Synthesis API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.");
        }
    }

    // --- –ì–û–õ–û–°–û–í–û–ô –í–í–û–î (STT) ---

    function startSpeechInput() {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            addMessage("–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ Chrome –∏–ª–∏ Edge.", 'ai', true);
            return;
        }

        if (isListening) {
            if (recognition) recognition.stop();
            return;
        }
        
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'ru-RU';
        
        recognition.onstart = () => {
            isListening = true;
            voiceButton.innerHTML = `
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="animate-pulse">
                    <circle cx="12" cy="12" r="3" fill="currentColor"/>
                    <path d="M12 8v8M8 12h8" stroke="currentColor" stroke-width="2"/>
                </svg>
            `;
            voiceButton.className = "p-3 text-red-500 bg-red-50 rounded-2xl hover:bg-red-100 transition-all duration-200 group";
            voiceButton.title = "–ó–∞–ø–∏—Å—å... –ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å";
            userInput.placeholder = "–ì–æ–≤–æ—Ä–∏—Ç–µ...";
        };

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            userInput.value = transcript;
            autoResize(userInput);
            if (transcript.trim().length > 0) {
                setTimeout(() => sendMessage(), 500);
            }
        };

        recognition.onend = () => {
            isListening = false;
            voiceButton.innerHTML = `
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="group-hover:scale-110 transition-transform duration-200">
                    <path d="M12 2a3 3 0 0 0-3 3v6a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z" stroke="currentColor" stroke-width="2"/>
                    <path d="M19 10v1a7 7 0 0 1-14 0v-1M12 18v4M8 22h8" stroke="currentColor" stroke-width="2"/>
                </svg>
            `;
            voiceButton.className = "p-3 text-blue-500 rounded-2xl hover:bg-blue-50 transition-all duration-200 group";
            voiceButton.title = "–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥";
            userInput.placeholder = "–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –≥–æ–≤–æ—Ä–∏—Ç–µ —Å TaFo AI...";
        };
        
        recognition.onerror = (event) => {
            console.error('–û—à–∏–±–∫–∞ STT:', event.error);
            addMessage(`–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞: ${event.error}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É.`, 'ai', true);
        };

        recognition.start();
    }

    // --- –û–ë–†–ê–ë–û–¢–ö–ê –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô ---

    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (!file) {
            removeImage();
            return;
        }

        if (!file.type.startsWith('image/')) {
            addMessage("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.", 'ai', true);
            removeImage();
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
            const base64String = e.target.result;
            const parts = base64String.split(';base64,');

            uploadedImageMimeType = parts[0].replace('data:', '');
            uploadedImageBase64 = parts[1];

            imagePreviewContainer.innerHTML = `
                <div class="flex items-center space-x-4 animate-slide-up">
                    <img src="${base64String}" alt="Preview" class="w-16 h-16 object-cover rounded-xl border-2 border-blue-200 shadow-sm">
                    <div class="flex-grow">
                        <h4 class="text-sm font-semibold text-blue-700">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ –∞–Ω–∞–ª–∏–∑—É</h4>
                        <p class="text-xs text-blue-500">${file.name}</p>
                    </div>
                    <button onclick="removeImage()" class="p-2 text-blue-400 hover:text-red-500 hover:bg-red-50 rounded-xl transition-all duration-200">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </button>
                </div>
            `;
            imagePreviewContainer.classList.remove('hidden');
            autoResize(userInput);
            userInput.focus();
        };
        reader.readAsDataURL(file);
    }

    function removeImage() {
        uploadedImageBase64 = null;
        uploadedImageMimeType = null;
        imageInput.value = '';
        imagePreviewContainer.innerHTML = '';
        imagePreviewContainer.classList.add('hidden');
        autoResize(userInput);
        userInput.focus();
    }

    // --- –õ–û–ì–ò–ö–ê –ß–ê–¢–ê –ò API ---

    function addMessage(text, sender, isError = false, imageBase64 = null) {
        const outerDiv = document.createElement('div');
        outerDiv.className = sender === 'user' ? 'user-message-container animate-slide-up' : 'ai-message-container animate-slide-up';

        const innerDiv = document.createElement('div');
        innerDiv.className = sender === 'user' ? 'user-message flex items-start space-x-4' : 'ai-message flex items-start space-x-4';
        
        const iconContainer = document.createElement('div');
        iconContainer.className = 'w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-full shadow-lg ' + 
            (sender === 'user' ? 'bg-gradient-to-br from-blue-500 to-blue-600 text-white' : 'bg-gradient-to-br from-blue-100 to-blue-200 text-blue-600');
        
        iconContainer.innerHTML = sender === 'user' 
            ? `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                 <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" stroke="currentColor" stroke-width="2"/>
               </svg>`
            : `<img src="tafoai.png" alt="TaFo AI" class="w-full h-full object-cover rounded-full">`;

        const contentDiv = document.createElement('div');
        contentDiv.className = 'flex-grow min-w-0';

        if (isError) {
            contentDiv.className += ' bg-red-50 border-l-4 border-red-400 text-red-700 p-4 rounded-r-xl';
            contentDiv.innerHTML = `
                <div class="flex items-center">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr-2">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                        <path d="M12 8v4M12 16h.01" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    <span class="font-medium">–û—à–∏–±–∫–∞</span>
                </div>
                <p class="mt-2">${text.replace(/\*\*(.*?)\*\*/g, '<strong class="font-bold">$1</strong>')}</p>
            `;
        } else {
            if (imageBase64) {
                contentDiv.innerHTML += `<img src="data:${uploadedImageMimeType};base64,${imageBase64}" class="max-w-sm max-h-64 rounded-2xl shadow-lg mb-4 object-contain border-2 border-blue-100" alt="–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">`;
            }

            let htmlContent = text.replace(/\*\*(.*?)\*\*/g, '<strong class="font-bold text-blue-700">$1</strong>');
            htmlContent = htmlContent.replace(/^- (.*)/gm, '<li class="ml-4 list-disc text-blue-600">$1</li>');
            htmlContent = htmlContent.replace(/# (.*)/g, '<h3 class="text-xl font-semibold mt-4 mb-2 text-blue-700">$1</h3>');
            htmlContent = htmlContent.replace(/\n/g, '<br>');
            
            contentDiv.innerHTML += `<div class="prose prose-blue max-w-none">${htmlContent}</div>`;
        }

        innerDiv.appendChild(iconContainer);
        innerDiv.appendChild(contentDiv);

        if (sender !== 'user') {
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'flex flex-col space-y-2 ml-2 self-start text-blue-400';
            actionsDiv.innerHTML = `
                <button onclick="copyToClipboard('${text.replace(/'/g, "\\'")}')" class="p-2 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-all duration-200" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" stroke="currentColor" stroke-width="2"/>
                    </svg>
                </button>
                <button onclick="speakText('${text.replace(/'/g, "\\'")}')" class="p-2 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-all duration-200" title="–û–∑–≤—É—á–∏—Ç—å">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M11 5L6 9H2v6h4l5 4V5zM19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07" stroke="currentColor" stroke-width="2"/>
                    </svg>
                </button>
            `;
            innerDiv.appendChild(actionsDiv);
        }

        outerDiv.appendChild(innerDiv);
        conversationArea.appendChild(outerDiv);
        chatBody.scrollTop = chatBody.scrollHeight;
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            showNotification('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
        }).catch(err => {
            console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
        });
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 p-4 rounded-xl shadow-2xl transition-all duration-300 transform translate-x-full ${
            type === 'success' ? 'bg-green-500 text-white' : 'bg-blue-500 text-white'
        }`;
        notification.innerHTML = `
            <div class="flex items-center">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr-2">
                    <path d="M9 12l2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                </svg>
                ${message}
            </div>
        `;
        document.body.appendChild(notification);
        
        setTimeout(() => notification.classList.remove('translate-x-full'), 100);
        setTimeout(() => {
            notification.classList.add('translate-x-full');
            setTimeout(() => document.body.removeChild(notification), 300);
        }, 3000);
    }

    async function sendMessage() {
        const prompt = userInput.value.trim();
        const hasImage = uploadedImageBase64 !== null;

        if ((!prompt && !hasImage) || isFetching) return;

        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —á–∞—Ç, –µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        if (!currentChatId) {
            createNewChat();
        }

        if (conversationContext.length === 0) {
            showConversation();
        }
        
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
        }

        isFetching = true;
        sendButton.disabled = true;
        userInput.disabled = true;

        const userParts = [];
        const currentImageBase64 = uploadedImageBase64;
        const currentImageMimeType = uploadedImageMimeType;

        if (hasImage) {
            userParts.push({
                inlineData: {
                    mimeType: uploadedImageMimeType,
                    data: uploadedImageBase64
                }
            });
        }
        
        if (prompt) {
             userParts.push({ text: prompt });
        } else if (hasImage) {
            userParts.push({ text: "–û–ø–∏—à–∏ —ç—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ." });
        }

        addMessage(prompt || "–ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è", 'user', false, currentImageBase64);
        
        const userMessage = { role: "user", parts: userParts };
        conversationContext.push(userMessage);

        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
        if (conversationContext.length === 1 && prompt) {
            updateChatTitle(currentChatId, prompt);
        }

        userInput.value = '';
        removeImage();
        autoResize(userInput); 

        const loadingIndicator = showLoadingIndicator();
        
        try {
            const systemPrompt = "–¢—ã –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ —É–º–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç TaFo AI –æ—Ç MusTaFo Company AI. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ —á–µ—Ç–∫–æ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è –≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏. –ü—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –±—É–¥—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–µ—Ç–∞–ª—å–Ω—ã–º. –ü–æ–º–Ω–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–∞.";
            
            const payload = {
                contents: conversationContext,
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    temperature: 0.7,
                    topK: 40,
                    topP: 0.95,
                    maxOutputTokens: 2048,
                }
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            const candidate = result.candidates?.[0];
            const aiText = candidate?.content?.parts?.[0]?.text || "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ —Å–º–æ–≥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç.";

            if (candidate && candidate.content) {
                const aiMessage = { role: "model", parts: candidate.content.parts };
                conversationContext.push(aiMessage);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞
                const currentChat = chatHistory.find(c => c.id === currentChatId);
                if (currentChat) {
                    currentChat.messages = [...conversationContext];
                    currentChat.lastActivity = new Date();
                    saveChatHistory();
                }
            }

            loadingIndicator.remove();
            addMessage(aiText, 'ai');
            speakText(aiText);

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ API:', error);
            
            loadingIndicator.remove();
            
            let errorMessage = "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.";
            if (error.message.includes('403')) {
                errorMessage = "–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ API. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.";
            }
            
            addMessage(errorMessage, 'ai', true);
            conversationContext.pop(); 
        } finally {
            isFetching = false;
            userInput.disabled = false;
            autoResize(userInput); 
            userInput.focus();
        }
    }

    // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï UI –ò –°–ò–î–ï–ë–ê–†–û–ú ---
    
    function toggleSidebar() {
        const isHidden = sidebar.classList.contains('-translate-x-full');
        if (isHidden) {
            sidebar.classList.remove('-translate-x-full');
            sidebarOverlay.classList.remove('opacity-0', 'pointer-events-none');
            sidebarOverlay.classList.add('opacity-50');
        } else {
            sidebar.classList.add('-translate-x-full');
            sidebarOverlay.classList.remove('opacity-50');
            sidebarOverlay.classList.add('opacity-0', 'pointer-events-none');
        }
    }
    
    function clearChat() {
        currentChatId = null;
        conversationContext = [];
        conversationArea.innerHTML = '';
        conversationArea.classList.add('hidden');
        welcomeScreen.classList.remove('hidden');
        userInput.value = '';
        removeImage();
        autoResize(userInput);
        userInput.focus();
        updateChatHistoryUI();
        
        if (!sidebar.classList.contains('-translate-x-full')) {
            toggleSidebar();
        }
        
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
        }
    }

    function showConversation() {
        welcomeScreen.classList.add('hidden');
        conversationArea.classList.remove('hidden');
        chatBody.scrollTop = chatBody.scrollHeight;
    }

    function showWelcomeScreen() {
        conversationArea.classList.add('hidden');
        welcomeScreen.classList.remove('hidden');
    }

    function showLoadingIndicator() {
        const outerDiv = document.createElement('div');
        outerDiv.className = 'ai-message-container animate-slide-up';

        const innerDiv = document.createElement('div');
        innerDiv.className = 'ai-message flex items-start space-x-4';
        innerDiv.innerHTML = `
            <div class="w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-full bg-gradient-to-br from-blue-100 to-blue-200 text-blue-600 overflow-hidden">
                <img src="https://via.placeholder.com/40x40/1976d2/ffffff?text=AI" alt="TaFo AI" class="w-full h-full object-cover rounded-full animate-pulse">
            </div>
            <div class="flex-grow min-w-0 flex items-center py-3">
                <div class="dot-pulse mr-2"></div>
                <span class="text-blue-500 text-sm font-medium">TaFo AI –¥—É–º–∞–µ—Ç...</span>
            </div>
        `;
        outerDiv.appendChild(innerDiv);
        conversationArea.appendChild(outerDiv);
        chatBody.scrollTop = chatBody.scrollHeight;
        return outerDiv;
    }

    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
    window.onload = function() {
        loadChatHistory();
        autoResize(userInput);
        userInput.focus();
    }
</script>
</body>

</html>
